<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="./style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css">
    <title>Create Calendar File</title>
    <script src = "./jquery.min.js"></script>
    <script src="http://cdn.date-fns.org/v1.0.0/date_fns.min.js"></script>
    <script type="text/javascript"
          src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCc3XpnPs0PHdGtzWHDPxe0lahDHOcv2P8&libraries=places"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.js"></script>
</head>
<body>
    <section class="calendar">
    <h1 class = 'title'>Create Calendar Event</h1>
    <div class="score">
        <table>
            <tbody>
                <tr>
                    <td>
                        Start Date:<br>
                        <input type="date" id="cal-start-date" onchange="autoPopulateEndDate()">
                        <br>
                    </td>
                    <td>
                        Start Time:<br>
                        <input type="time" id="cal-start-time" onchange="autoPopulateEndTime()">
                        <br>
                        
                    </td>
                </tr>
                <tr>
                    <td>
                        End Date:<br>
                        <input type="date" id="cal-end-date">
                        <br>
                    </td>
                    <td>
                        End Time:<br>
                        <input type="time" id="cal-end-time">
                        <br>
                    </td>
                </tr>
                <tr>
                    <td>
                        Location:<br>
                        <input type="text" id="cal-location" placeholder="name">
                        <br>
                    </td>
                    <td>
                        <br>
                        <button onclick="openModal()"
                            style="vertical-align: bottom"
                        >Choose On Map</button>
                    </td>
                </tr>
                <tr>
                    <td colspan="2">
                        Details:<br>
                        <input type="text" id="cal-details" style="width: 100%">
                        <br>
                    </td>
                </tr>
                <tr>
                    <td>Recurrence:<br>
                        <select id="cal-recurrence">
                            <option value="false">Does not repeat</option>
                            <option value="DAILY">Daily</option>
                            <option value="WEEKLY">Weekly</option>
                            <option value="MONTHLY">Monthly</option>
                            <option value="YEARLY">Annually</option>
                        </select>
                        <br>
                    </td>
                    <td>

                    </td>
                </tr>
                <tr>

                </tr>
                <tr>
                    <td>
                        <br>
                        <button id = 'btnSaveNDownload'> Save and Download</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    </section>
    <div class="ui modal">
        <div class="header">
            Choose Location
        </div>
        <div class="content">
            <div class="ui red message">NOTE: THIS FEATURE IS ONLY CURRENTLY SUPPORTED BY THE THE APPLE CALENDAR APP</div>
            <div class="search-group">
                <label>Search:</label>
                <input id="pac-input" class="controls" type="text" placeholder="Enter a location">
            </div>
            <div id="map" style="min-height: 40vh;"></div>
        </div>
        <div class="actions">
            <div class="ui black deny button" onclick="resetLocation()">
                Cancel
            </div>
            <div class="ui green right labeled icon button" id="confirmPosition">
                Confirm Location
                <i class="checkmark icon"></i>
            </div>
        </div>
      </div>
</body>
</html>

<script>
    // DATE FUNCTIONS
    function validateForm(startDate, startTime, endDate, endTime, location, details) {
        return startDate && startTime && endDate && endTime && location && details
    }
    
    function checkDates(startDate, startTime, endDate, endTime) {
        if (endDate < startDate) {
            alert('Start date must start before end date.');
            return false;
        }
        if (endTime < startTime && startDate === endDate) {
            alert('Start time must start before end time.');
            return false;
        }
        return true;
    }

    function formatIcsDate(dateString, timeString) {

        let dateObj = new Date(dateString+' '+timeString);

        // 20190713T200000Z
        return dateFns.format(dateObj, 'YYYYMMDDTHHmmss');
    }
    
    function recursionDates(rRule) {    
        if (rRule === "false") {
            return "";
        }
        else {
            let retVal = "RRULE:FREQ=" + rRule + '\n';
            return retVal;
        }
    }
    
    function autoPopulateEndDate(){
        let startDate = document.getElementById('cal-start-date').value;
        document.getElementById('cal-end-date').value = startDate;
    }

    function autoPopulateEndTime(){
        let startTime = document.getElementById('cal-start-time').value;
        document.getElementById('cal-end-time').value = startTime;
    }


    // DOWNLOAD FUNCTION
    $(document).ready(function (){
        $('#btnSaveNDownload').click(function() {

            // Grab Form Data
            let startDate = document.getElementById('cal-start-date').value;
            let endDate = document.getElementById('cal-end-date').value;
            let startTime = document.getElementById('cal-start-time').value;
            let endTime = document.getElementById('cal-end-time').value;
            let rRule = document.getElementById('cal-recurrence').value;
            let location = document.getElementById('cal-location').value;
            let details = document.getElementById('cal-details').value;
          
            // Validate Form
            if(validateForm(startDate, startTime, endDate, endTime, location, details)
               && checkDates(startDate, startTime, endDate, endTime)) {
                let formattedStart = formatIcsDate(startDate, startTime);
                let formattedEnd = formatIcsDate(endDate, endTime);

                let header = 'BEGIN:VCALENDAR' + '\n' + 'VERSION:2.0' +
                     '\n' + 'PRODID:-//Google Inc//Google Calendar 70.9054//EN' +
                     '\n' + 'BEGIN:VEVENT' + '\n';

                let userDetails = "DTSTART:" + formattedStart + '\n' + "DTEND:" + formattedEnd + '\n';

                let recurrence = recursionDates(rRule);

                let eventDetails = "SUMMARY:" + details + '\n';

                if(locationLatitude && locationLongitude){
                    locationLatitude = locationLatitude.toFixed(6);
                    locationLongitude = locationLongitude.toFixed(6);
                    eventDetails = eventDetails
                        // For G-cal, works if location name is a valid place in G-maps i.e. address
                        + "LOCATION;ALTREP=\""+ locationLatitude + "," + locationLongitude +"\":" + location + '\n'
                        // For Apple iCalendar and iOS, works perfectly
                        + "X-APPLE-STRUCTURED-LOCATION;VALUE=URI;X-APPLE-RADIUS=72;X-TITLE="
                        + location +":geo:" + locationLatitude + "," + locationLongitude + '\n'
                        // Official iCal standard for Lat/Long but not supported by most calendar apps
                        + "GEO:" + locationLatitude + "," + locationLongitude + '\n';
                } else {
                    eventDetails = eventDetails + "LOCATION:"+ location + '\n';
                }

                let tail = 'END:VEVENT'+ '\n'+ 'END:VCALENDAR';

                let blob = new Blob([header + userDetails + recurrence + eventDetails + tail],
                {
                    type: "application/json;utf - 8"
                }
                );

                let userLink = document.createElement('a');
                userLink.setAttribute('download', details.replace(/ /g,"_") + '_cal_event' + '.ics');
                userLink.setAttribute('href', window.URL.createObjectURL(blob));
                userLink.click();
            }
            // Incomplete form
            else {
                alert('Please fill out all form fields!');
            }
        });
    });

    // MAP FUNCTIONS AND VARS

    // Map Variables
    let lp;
    let mapSearchInput;
    let currentMarker;
    let searchBox;
    let locationLatitude;
    let locationLongitude;

    // Modified from https://www.w3schools.com/html/tryit.asp?filename=tryhtml5_geolocation
    function getLocationInit(callback) {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                locationLatitude = position.coords.latitude
                locationLongitude = position.coords.longitude;
                callback();
            });
        } else { 
            // default to UH Manoa
            locationLatitude = 21.296939;
            locationLongitude = -157.8193005;
            callback();
        }
    }

    function setPosition(position) {
        locationLatitude = position.coords.latitude
        locationLongitude = position.coords.longitude;
    }

    function resetLocation(){
        locationLatitude = null;
        locationLongitude = null;
    }

    function openModal(){
        $('.ui.modal').modal('show');
        getLocationInit(initSearchMap);
    }

    let confirmBtn = document.getElementById('confirmPosition');
    // Listen to button onclick event
    confirmBtn.onclick = function () {
        $('.ui.modal').modal('hide');
    };

    function initSearchMap() {
        lp = new google.maps.Map(document.getElementById('map'), {
          center: {lat: parseFloat(locationLatitude), lng: parseFloat(locationLongitude)},
          zoom: 13,
          mapTypeId: 'roadmap'
        });

        // Create the search box and link it to the UI element.
        mapSearchInput = document.getElementById('pac-input');
        searchBox = new google.maps.places.SearchBox(mapSearchInput);

        // Bias the SearchBox results towards current map's viewport.
        lp.addListener('bounds_changed', function() {
          searchBox.setBounds(lp.getBounds());
        });

        let markers = [];
        // Listen for the event fired when the user selects a prediction and retrieve
        // more details for that place.
        searchBox.addListener('places_changed', function() {
          let places = searchBox.getPlaces();

          if (places.length == 0) {
            return;
          }

          // Clear out the old markers.
          markers.forEach(function(marker) {
            marker.setMap(null);
          });
          markers = [];

          // For each place, get the icon, name and location.
          let bounds = new google.maps.LatLngBounds();
          places.forEach(function(place) {
            if (!place.geometry) {
              console.log("Returned place contains no geometry");
              return;
            }
            let icon = {
              url: place.icon,
              size: new google.maps.Size(71, 71),
              origin: new google.maps.Point(0, 0),
              anchor: new google.maps.Point(17, 34),
              scaledSize: new google.maps.Size(25, 25)
            };

            // Create a marker for each place.
            markers.push(new google.maps.Marker({
              map: lp,
              icon: icon,
              title: place.name,
              position: place.geometry.location
            }));

            markers.forEach((pin) => {
                pin.addListener('click', function() {
                    lp.setZoom(20);
                    lp.setCenter(pin.getPosition());
                    setPosition({
                        coords: {
                            latitude: pin.getPosition().lat(),
                            longitude: pin.getPosition().lng()
                        }
                    });
                });
            })

            if (place.geometry.viewport) {
              // Only geocodes have viewport.
              bounds.union(place.geometry.viewport);
            } else {
              bounds.extend(place.geometry.location);
            }
          });
          lp.fitBounds(bounds);
        });

        google.maps.event.addListener(lp, "click", googleMapClickHandler);
      }

    // Drop custom pin w/o search query
    function googleMapClickHandler(event) {
        // Remove old pin
        if(currentMarker){
            currentMarker.setMap(null);
        }
        // Set new pin
        currentMarker = new google.maps.Marker({
            position: event.latLng, 
            map: lp
        });
        // Set position variables
        setPosition({
            coords: {
                latitude: event.latLng.lat(),
                longitude: event.latLng.lng()
            }
        });
    }

</script>