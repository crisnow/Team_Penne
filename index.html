<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <title>Penne Calendar App</title>
    <script src = "./jquery.min.js"></script>
    <script src="http://cdn.date-fns.org/v1.0.0/date_fns.min.js"></script>
</head>
<body>
    <h1>Create Calendar Event</h1>
    <table> 
        <tr>
            <td>
                Start Date:<br>
                <input type="date" id="cal-start-date">
                <br>
            </td>
            <td>
                End Date:<br>
                <input type="date" id="cal-end-date">
                <br>
            </td>
            <td>
                Recurring:<br>
                <select id="cal-recurrence">
                    <option value="false">Does not repeat</option>
                    <option value="DAILY">Daily</option>
                    <option value="WEEKLY">Weekly</option>
                    <option value="MONTHLY">Monthly</option>
                    <option value="YEARLY">Annually</option>
                </select>
            </td>
        </tr>
        <tr>
            <td>
                Start Time:<br>
                <input type="time" id="cal-start-time">
                <br>
            </td>
            <td>
                End Time:<br>
                <input type="time" id="cal-end-time">
                <br>
            </td>
        </tr>
        <tr>
            <td>
                Location:<br>
                <input type="text" id="cal-location">
                <br>
            </td>
            <td>
                Details:<br>
                <input type="text" id="cal-details">
                <br>
            </td>
        </tr>
        <tr>
            <td></td>
            <td>
                <button id = 'btnSaveNDownload'> Save and Download</button>
            </td>
        </tr>
    </table>
</body>
</html>

<script>
    function validateForm(startDate, startTime, endDate, endTime, location, details) {
        return startDate && startTime && endDate && endTime && location && details
    }
    
    function checkDates(startDate, startTime, endDate, endTime) {
        if (endDate < startDate) {
            alert('Start date must start before end date.');
            return false;
        }
        if (endTime < startTime && startDate === endDate) {
            alert('Start time must start before end time.');
            return false;
        }
        return true;
    }

    function formatIcsDate(dateString, timeString) {

        let dateObj = new Date(dateString+' '+timeString);

        // 20190713T200000Z
        return dateFns.format(dateObj, 'YYYYMMDDTHHmmss');
    }
    
    function recursionDates(rRule) {    
        if (rRule === "false") {
            return "";
        }
        else {
            let retVal = "RRULE:FREQ=" + rRule + '\n';
            return retVal;
        }
    }

    $(document).ready(function (){
        $('#btnSaveNDownload').click(function() {

            // Grab Form Data
            let startDate = document.getElementById('cal-start-date').value;
            let endDate = document.getElementById('cal-end-date').value;
            let rRule = document.getElementById('cal-recurrence').value;
            let startTime = document.getElementById('cal-start-time').value;
            let endTime = document.getElementById('cal-end-time').value;
            let location = document.getElementById('cal-location').value;
            let details = document.getElementById('cal-details').value;

            // Check dates
            if (checkDates(startDate, startTime, endDate, endTime)) {
                // Validate Form
                if(validateForm(startDate, startTime, endDate, endTime, location, details)) {
                    let formattedStart = formatIcsDate(startDate, startTime);
                    let formattedEnd = formatIcsDate(endDate, endTime);

                    let header = 'BEGIN:VCALENDAR' + '\n' + 'VERSION:2.0' +
                         '\n' + 'PRODID:-//Google Inc//Google Calendar 70.9054//EN' +
                         '\n' + 'BEGIN:VEVENT' + '\n';
                         
                    let userDetails = "DTSTART:" + formattedStart + '\n' + "DTEND:" + formattedEnd + '\n';
                    
                    let recurrence = recursionDates(rRule);
                    
                    let eventDetails = "SUMMARY:" + details + '\n' + "LOCATION:" + location + '\n';
                    
                    let tail = 'END:VEVENT'+ '\n'+ 'END:VCALENDAR';


                    let blob = new Blob([header + userDetails + recurrence + eventDetails + tail],
                    {
                        type: "application/json;utf - 8"

                    }
                    )

                    let userLink = document.createElement('a');
                    userLink.setAttribute('download', details.replace(/ /g,"_") + '_cal_event' + '.ics');
                    userLink.setAttribute('href', window.URL.createObjectURL(blob));
                    userLink.click();
                }
                // Incomplete form
                else {
                    alert('Please fill out all form fields!');
                }
            }
        });
    });
</script>